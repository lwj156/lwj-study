# 深入理解Java虚拟机读书笔记

## OOM

> 内存溢出的时候Dump快照
>
>  -XX：+HeapDumpOnOutOf-MemoryError

 

方法区的实现：永久代和元空间都是方法区的实现

1. jdk<=1.6：永久代，常量池位于永久代中
2. jdk>1.6：元空间，常量池子位于堆中



## GC相关

### 判断对象GC条件

1. 引用计数器：循环引用无法回收问题
2. 可达性算法
   - 两次标记：一次查看是否有finalized（）方法需要执行：`逃脱GC的最后机会`，第二次则进行回收

### 对象引用状态

强、软、弱、虚

强：关系存在不回收

软：OOM之前，进行第二次GC

弱：GC时一定回收

虚：回收收到系统通知

### 常见问题

1. 跨代引用回收：新生代与老年代直接的互相引用会导致遍历对象增多。jvm引入`记忆集`，把老年代分成若干小块，Minor GC的跨代引用只扫描包含跨代引用的集合

### 常见概念

1. 分配担保：当Survivor空间不足容纳Minor GC后存活的对象，就依赖老年代进行分配担保，直接进入老年代
2. 如何解决标记-清除的空间碎片：通过内存分配/访问器
3. 可达性算法在`枚举根节点`的时候需要停顿，而在查找引用链过程中不需要停顿
4. 可达性算法过程采用三色标记

### 暂停到GC安全点的方式

1. 抢先式中断：先全部中断
2. 主动式中断：通过标志位到最近安全点中断，参考线程的interrupt

![image-20200819111350738](https://gitee.com/lwj156/picture/raw/master/image/mybatis/image-20200819111350738.png)

使用-XX：+UseConcMarkSweepGC配置指定CMS

- Shenandoah和ZGC 有空可以了解

